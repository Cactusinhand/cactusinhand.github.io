
<!DOCTYPE html><html lang="zh-CN">

<head>
  <meta charset="utf-8">
  <meta name="hexo-theme" content="https://github.com/xaoxuu/hexo-theme-stellar/tree/1.28.1" theme-name="Stellar" theme-version="1.28.1">
  
  <meta name="generator" content="Hexo 5.4.1">
  <meta http-equiv='x-dns-prefetch-control' content='on' />
  
  <meta name="renderer" content="webkit">
  <meta name="force-rendering" content="webkit">
  <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
  <meta name="HandheldFriendly" content="True" >
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="theme-color" media="(prefers-color-scheme: light)" content="#f9fafb">
  <meta name="theme-color" media="(prefers-color-scheme: dark)" content="#000">
  
  <title>如何向 Git 社区提交代码(2) - 高桥一郎</title>

  
    <meta name="description" content="第一次向 Git 社区提交代码起源于 Gitee 的一个需求">
<meta property="og:type" content="article">
<meta property="og:title" content="如何向 Git 社区提交代码(2)">
<meta property="og:url" content="https://cactusinhand.github.io/posts/23bf24d1.html">
<meta property="og:site_name" content="高桥一郎">
<meta property="og:description" content="第一次向 Git 社区提交代码起源于 Gitee 的一个需求">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2022-08-29T16:02:28.000Z">
<meta property="article:modified_time" content="2024-05-10T14:18:37.211Z">
<meta property="article:author" content="Cactusinhand">
<meta property="article:tag" content="Workflow">
<meta property="article:tag" content="Git">
<meta name="twitter:card" content="summary_large_image">
  
  
  
  <meta name="keywords" content="Workflow,Git">

  <!-- feed -->
  

  <link rel="stylesheet" href="/css/main.css?v=1.28.1">

  

  

  
</head>
<body>

<div class="l_body s:aa content tech" id="start" layout="post" ><aside class="l_left"><div class="leftbar-container">


<header class="header"><div class="logo-wrap"><a class="avatar" href="../about/"><div class="bg" style="opacity:0;background-image:url(https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.12/avatar/round/rainbow64@3x.webp);"></div><img no-lazy class="avatar" src="https://cdn.jsdelivr.net/gh/Cactusinhand/images_repo/images/image-20220213142754407.png" onerror="javascript:this.classList.add('error');this.src='https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.12/image/2659360.svg';"></a><a class="title" href="../index.html"><div class="main" ff="title">高桥一郎</div><div class="sub cap">Great minds think different.</div></a></div></header>

<div class="nav-area">
<div class="search-wrapper" id="search-wrapper"><form class="search-form"><a class="search-button" onclick="document.getElementById(&quot;search-input&quot;).focus();"><svg t="1705074644177" viewBox="0 0 1025 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="1560" width="200" height="200"><path d="M1008.839137 935.96571L792.364903 719.491476a56.783488 56.783488 0 0 0-80.152866 0 358.53545 358.53545 0 1 1 100.857314-335.166073 362.840335 362.840335 0 0 1-3.689902 170.145468 51.248635 51.248635 0 1 0 99.217358 26.444296 462.057693 462.057693 0 1 0-158.255785 242.303546l185.930047 185.725053a51.248635 51.248635 0 0 0 72.568068 0 51.248635 51.248635 0 0 0 0-72.978056z" p-id="1561"></path><path d="M616.479587 615.969233a50.428657 50.428657 0 0 0-61.498362-5.534852 174.655348 174.655348 0 0 1-177.525271 3.484907 49.403684 49.403684 0 0 0-58.833433 6.76482l-3.074918 2.869923a49.403684 49.403684 0 0 0 8.609771 78.10292 277.767601 277.767601 0 0 0 286.992355-5.739847 49.403684 49.403684 0 0 0 8.404776-76.667958z" p-id="1562"></path></svg></a><input type="text" class="search-input" id="search-input" placeholder="站内搜索"></form><div id="search-result"></div><div class="search-no-result">没有找到内容！</div></div>


<nav class="menu dis-select"></nav>
</div>
<div class="widgets">


<widget class="widget-wrapper post-list"><div class="widget-header dis-select"><span class="name">最近更新</span></div><div class="widget-body fs14"><a class="item title" href="4da024a6.html"><span class="title">docker 的使用笔记</span></a><a class="item title" href="767b1d3c.html"><span class="title">学习 Rust 的一些笔记</span></a><a class="item title" href="c5ceb3cc.html"><span class="title">Git 炸弹</span></a><a class="item title" href=""><span class="title">如何向 Git 社区提交代码(2)</span></a><a class="item title" href="d699447b.html"><span class="title">如何向 Git 社区提交代码</span></a><a class="item title" href="f8df64f6.html"><span class="title">GitOps: 一种 DevOps 的最佳实践</span></a><a class="item title" href="92e91caf.html"><span class="title">一种 Git 插件工具：git repo-clean</span></a><a class="item title" href="4fad1e06.html"><span class="title">Git 内部原理</span></a><a class="item title" href="32c910d1.html"><span class="title">git bundle 格式及应用</span></a><a class="item title" href="341c748.html"><span class="title">Design pattern in Gitlay(Git PRC service)</span></a></div></widget>
</div>

</div></aside><div class="l_main" id="main">





<div class="article banner top">
  <div class="content">
    <div class="top bread-nav footnote"><div class="left"><div class="flex-row" id="breadcrumb"><a class="cap breadcrumb" href="../index.html">主页</a>
<span class="sep"></span><a class="cap breadcrumb" href="../">文章</a><span class="sep"></span><a class="cap breadcrumb-link" href="../categories/Git/">Git</a></div>
<div class="flex-row" id="post-meta"><span class="text created">发布于：<time datetime="2022-08-29T16:02:28.000Z">2022-08-30</time></span><span class="sep updated"></span><span class="text updated">更新于：<time datetime="2024-05-10T14:18:37.211Z">2024-05-10</time></span></div></div></div>
    
    <div class="bottom only-title">
      
      <div class="text-area">
        <h1 class="text title"><span>向 Git 社区提交代码(二)</span></h1>
        
      </div>
    </div>
    
  </div>
  </div><article class="md-text content"><h3 id="背景">背景</h3>
<p>第一次向 Git 社区提交代码起源于 Gitee 的一个需求。Gitee 创建新仓库有多种方式，其中一种是根据用户提供的仓库 URL 导入新仓库，Gitee 首先会对用户提供的 URL 进行校验，只有合格的仓库地址才会生成新仓库。但是有种情况比较特别，若用户确实提供了一个合法的 Git 仓库地址，但是这个仓库不是完整的，常见的情况就是浅仓库(shallow repo)，这类仓库缺乏足够的历史提交信息，因此会带来一些问题。为了避免这种情况，在服务端就需要对用户导入的仓库进行特别处理。在服务端，导入仓库的动作本质上就是执行 <code>git clone --mirror</code> 命令，那么有没有可能在执行这个克隆命令的过程中就对仓库进行判断呢？如果能，这将避免克隆完整个仓库再进行判断仓库是否为浅仓库，这样无疑更有效。于是我开始研究 Git 源码，琢磨如何给 <code>git-clone</code> 命令赋予一项新的能力。</p>
<p>按照前面的方法向 Git 社区提交了第一版代码：<a target="_blank" rel="noopener" href="https://public-inbox.org/git/pull.865.git.1612409491842.gitgitgadget@gmail.com/#t">v1</a></p>
<p>很快收到 <strong><a target="_blank" rel="noopener" href="https://public-inbox.org/git/xmqq35yc9yan.fsf@gitster.c.googlers.com/#t">Junio C Hamano</a></strong> 反馈，主要问题有：</p>
<ul class="lvl-0">
<li class="lvl-2">
<p>commit 信息中说明不清，英文语法错误：</p>
</li>
</ul>
<pre class="line-numbers language-none"><code class="language-none">&gt; This patch add a new option that reject to clone a shallow repository.

A canonical form of our log message starts by explaining the need,
and then presents the solution at the end.
一条规范的 commit 信息格式应该是在开始就解释更改需求，然后在结尾提供解决方案。

&gt; Clients don&#39;t know it&#39;s a shallow repository until they download it
&gt; locally, in some scenariors, clients just don&#39;t want to clone this kind

&quot;scenarios&quot;.  &quot;in some scenarios&quot; would have to be clarified a bit
more to justify why it is a good idea to have such a feature.
这里的需求场景描述地不够有说服力。

&gt; of repository, and want to exit the process immediately without creating
&gt; any unnecessary files.

&quot;clients don&#39;t know it&#39;s a shallow repository until they download&quot;
leading to &quot;so let&#39;s reject immediately upon finding out that they
are shallow&quot; does make sense as a flow of thought, though.
这里表述不够清晰，Junio 顺便提供了他的建议
&gt; +--no-shallow::
&gt; +	Don&#39;t clone a shallow source repository. In some scenariors, clients

&quot;scenarios&quot; (no &#39;r&#39;).<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul class="lvl-0">
<li class="lvl-2">
<p>新增选项 <code>--no-shallow</code> 不对，应该考虑到布尔类选项存在反选情况，即 <code>--no-no-shallow</code> ，因此不应该这么写，建议改为 <code>--reject-shallow</code>， 它的反选即为 <code>--no-reject-shallow</code>，这样语义上也更符合直觉：</p>
</li>
</ul>
<pre class="line-numbers language-diff" data-language="diff"><code class="language-diff"><span class="token inserted-arrow inserted"><span class="token prefix inserted">></span><span class="token line"> diff --git a/builtin/clone.c b/builtin/clone.c
</span></span>
<span class="token inserted-arrow inserted"><span class="token prefix inserted">></span><span class="token line"> @@ -90,6 +91,7 @@ static struct option builtin_clone_options[] = &#123;
</span><span class="token prefix inserted">></span><span class="token line">  	OPT__VERBOSITY(&amp;option_verbosity),
</span><span class="token prefix inserted">></span><span class="token line">  	OPT_BOOL(0, "progress", &amp;option_progress,
</span><span class="token prefix inserted">></span><span class="token line">  		 N_("force progress reporting")),
</span><span class="token prefix inserted">></span><span class="token line"> +	OPT_BOOL(0, "no-shallow", &amp;option_no_shallow, N_("don't clone shallow repository")),
</span><span class="token prefix inserted">></span><span class="token line">  	OPT_BOOL('n', "no-checkout", &amp;option_no_checkout,
</span><span class="token prefix inserted">></span><span class="token line">  		 N_("don't create a checkout")),
</span><span class="token prefix inserted">></span><span class="token line">  	OPT_BOOL(0, "bare", &amp;option_bare, N_("create a bare repository")),
</span></span>
It is a bad idea to give a name that begins with "no-" to an option
whose default can be tweaked by a configuration variable [*].  If
the configuration is named "rejectshallow", perhaps it is better to
call it "--reject-shallow" instead.

This is because configured default must be overridable from the
command line.  I.e. even if you have in your ~/.gitconfig this:

<span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">   [clone]
</span><span class="token prefix unchanged"> </span><span class="token line">       rejectshallow = true
</span></span>
you should be able to say "allow it only this time", with

<span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">   $ git clone --no-reject-shallow http://github.com/git/git/ git
</span></span>
and you do not want to have to say "--no-no-shallow", which sounds
just silly.

	Side note. it is a bad idea in general, even if the option
	does not have corresponding configuration variable.  The
	existing "no-checkout" is a historical accident that
	happened long time ago and cannot be removed due to
	compatibility.  Let's not introduce a new option that
	follows such a bad pattern.

	Junio 进一步解释：现存的选项 `no-checkout` 是一个很久之前的历史错误，
	由于兼容性，已经无法移除这个错误了，现在新的选项不应该按照这种模式命名。
	P.S. 刚好我就是按照`no-checkout`选项的模式创造出`no-shllow`选项的-:)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>更重要的是，<strong>命令行优先于配置</strong>，即命令行选项要能够覆盖配置文件选项。当配置文件从全局上不允许克隆 shllow 仓库时，而用户想要允许单次克隆 shallow 仓库时，自然地，他会使用 <code>--no-shallow</code> 选项的反选项 <code>--no-no-shallow</code> 来覆盖掉配置中的选项 。但这样 <code>--no-no-shallow</code> 听来去就很傻。</p>
<ul class="lvl-0">
<li class="lvl-2">
<p>由于 Git 存在多种传输协议，目前的修改只是解决了本地克隆问题，因此仍需改进：</p>
</li>
</ul>
<pre class="line-numbers language-diff" data-language="diff"><code class="language-diff"><span class="token inserted-arrow inserted"><span class="token prefix inserted">></span><span class="token line"> @@ -963,6 +968,7 @@ static int path_exists(const char *path)
</span><span class="token prefix inserted">></span><span class="token line">  int cmd_clone(int argc, const char **argv, const char *prefix)
</span><span class="token prefix inserted">></span><span class="token line">  &#123;
</span><span class="token prefix inserted">></span><span class="token line">  	int is_bundle = 0, is_local;
</span><span class="token prefix inserted">></span><span class="token line"> +	int is_shallow = 0;
</span><span class="token prefix inserted">></span><span class="token line">  	const char *repo_name, *repo, *work_tree, *git_dir;
</span><span class="token prefix inserted">></span><span class="token line">  	char *path, *dir, *display_repo = NULL;
</span><span class="token prefix inserted">></span><span class="token line">  	int dest_exists, real_dest_exists = 0;
</span><span class="token prefix inserted">></span><span class="token line"> @@ -1215,6 +1221,7 @@ int cmd_clone(int argc, const char **argv, const char *prefix)
</span><span class="token prefix inserted">></span><span class="token line">  		if (filter_options.choice)
</span><span class="token prefix inserted">></span><span class="token line">  			warning(_("--filter is ignored in local clones; use file:// instead."));
</span><span class="token prefix inserted">></span><span class="token line">  		if (!access(mkpath("%s/shallow", path), F_OK)) &#123;
</span><span class="token prefix inserted">></span><span class="token line"> +			is_shallow = 1;
</span><span class="token prefix inserted">></span><span class="token line">  			if (option_local > 0)
</span><span class="token prefix inserted">></span><span class="token line">  				warning(_("source repository is shallow, ignoring --local"));
</span><span class="token prefix inserted">></span><span class="token line">  			is_local = 0;
</span></span>
This change is to the local clone codepath.  Cloning over the wire
would not go through this part.  And throughout the patch, this is
the only place that sets is_shallow to 1.

Also let's note that this is after we called parse_options(), so the
value of option_no_shallow is known at this point.

So, this patch does not even *need* to introduce a new "is_shallow"
variable at all.  It only needs to add

<span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">                       if (option_no_shallow)
</span><span class="token prefix unchanged"> </span><span class="token line">                               die(...);
</span></span>
instead of adding "is_shallow = 1" to the above hunk.

I somehow think that this is only half a feature---wouldn't it be
more useful if we also rejected a non-local clone from a shallow
repository?
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul class="lvl-0">
<li class="lvl-2">
<p>测试代码中的问题：</p>
</li>
</ul>
<pre class="line-numbers language-diff" data-language="diff"><code class="language-diff">And for that ...

<span class="token inserted-arrow inserted"><span class="token prefix inserted">></span><span class="token line"> diff --git a/t/t5606-clone-options.sh b/t/t5606-clone-options.sh
</span><span class="token prefix inserted">></span><span class="token line"> index 7f082fb23b6a..9d310dbb158a 100755
</span><span class="token prefix inserted">></span><span class="token line"> --- a/t/t5606-clone-options.sh
</span><span class="token prefix inserted">></span><span class="token line"> +++ b/t/t5606-clone-options.sh
</span><span class="token prefix inserted">></span><span class="token line"> @@ -42,6 +42,13 @@ test_expect_success 'disallows --bare with --separate-git-dir' '
</span><span class="token prefix inserted">></span><span class="token line">  
</span><span class="token prefix inserted">></span><span class="token line">  '
</span><span class="token prefix inserted">></span><span class="token line">  
</span><span class="token prefix inserted">></span><span class="token line"> +test_expect_success 'reject clone shallow repository' '
</span><span class="token prefix inserted">></span><span class="token line"> +	git clone --depth=1 --no-local parent shallow-repo &amp;&amp;
</span><span class="token prefix inserted">></span><span class="token line"> +	test_must_fail git clone --no-shallow shallow-repo out 2>err &amp;&amp;
</span><span class="token prefix inserted">></span><span class="token line"> +	test_i18ngrep -e "source repository is shallow, reject to clone." err
</span><span class="token prefix inserted">></span><span class="token line"> +
</span><span class="token prefix inserted">></span><span class="token line"> +'
</span><span class="token prefix inserted">></span><span class="token line"> +
</span></span>
... in addition to the test for a local clone above, you'd also want
to test a non-local clone, perhaps like so:

test_expect_success 'reject clone shallow repository' '
	rm -fr shallow-repo &amp;&amp;
	git clone --depth=1 --no-local parent shallow-repo &amp;&amp;
	test_must_fail git clone --no-shallow --no-local shallow-repo out 2>err &amp;&amp;
	test_i18ngrep -e "source repository is shallow, reject to clone." err

'

Ditto for the other test script.

Also, you would want to make sure that the command line overrides
the configured default.  I.e.

	git -c clone.rejectshallow=false clone --reject-shallow

should refuse to clone from a shallow one, while there should be a
way to countermand a configured "I always refuse to clone from a
shallow repository" with "but let's allow it only this time", i.e.

	git -c clone.rejectshallow=true clone --no-reject-shallow

or something along the line.


<span class="token inserted-arrow inserted"><span class="token prefix inserted">></span><span class="token line"> diff --git a/t/t5611-clone-config.sh b/t/t5611-clone-config.sh
</span><span class="token prefix inserted">></span><span class="token line"> index 8e0fd398236b..3aab86ad4def 100755
</span><span class="token prefix inserted">></span><span class="token line"> --- a/t/t5611-clone-config.sh
</span><span class="token prefix inserted">></span><span class="token line"> +++ b/t/t5611-clone-config.sh
</span><span class="token prefix inserted">></span><span class="token line"> @@ -92,6 +92,13 @@ test_expect_success 'clone -c remote.&lt;remote>.fetch=&lt;refspec> --origin=&lt;name>' '
</span><span class="token prefix inserted">></span><span class="token line">  	test_cmp expect actual
</span><span class="token prefix inserted">></span><span class="token line">  '
</span><span class="token prefix inserted">></span><span class="token line">  
</span><span class="token prefix inserted">></span><span class="token line"> +test_expect_success 'clone -c clone.rejectshallow' '
</span><span class="token prefix inserted">></span><span class="token line"> +	rm -rf child &amp;&amp;
</span><span class="token prefix inserted">></span><span class="token line"> +	git clone --depth=1 --no-local . child &amp;&amp;
</span><span class="token prefix inserted">></span><span class="token line"> +	test_must_fail git clone -c clone.rejectshallow child out 2>err &amp;&amp;
</span></span>
This is not quite right, even though it may happen to work.  The
"clone.rejectshallow" variable is a configuration about what should
happen when creating a new repository by cloning, so letting "git
clone -c var[=val]" to set the variable _in_ the resulting repository
would not make much sense.  Even if the clone succeeded, nobody would
look at that particular configuration variable that is set in the
resulting repository.

I think it would communicate to the readers better what we are
trying to do, if we write

	test_must_fail git -c clone.rejectshallow=true clone child out

instead.

Thanks.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>通过测试代码 Junio 指出： <code>clone.rejectshallow</code> 配置和命令行选项 <code>--reject-shallow</code> 存在逻辑上的交叉重叠问题，因此测试时应该体现出这一点。</p>
<p>以上就是我第一次提交的代码，没想到能很快收到那么多宝贵的检视建议。但是，这只是开始，后面还有更多的检视回合，收到了更加细致的检视意见。</p>
<p>比如 <a target="_blank" rel="noopener" href="https://public-inbox.org/git/nycvar.QRO.7.76.6.2103311146210.52@tvgsbejvaqbjf.bet/">Johannes Schindelin</a> 给了一些意见：</p>
<pre class="line-numbers language-diff" data-language="diff"><code class="language-diff">我觉得这个补丁大部分都很好，但我还有一点点改进建议
I like most of the patch, and will only point out a couple of things that
I think can be improved even further.

<span class="token inserted-arrow inserted"><span class="token prefix inserted">></span><span class="token line"> diff --git a/Documentation/git-clone.txt b/Documentation/git-clone.txt
</span><span class="token prefix inserted">></span><span class="token line"> index 02d9c19cec75..0adc98fa7eee 100644
</span><span class="token prefix inserted">></span><span class="token line"> --- a/Documentation/git-clone.txt
</span><span class="token prefix inserted">></span><span class="token line"> +++ b/Documentation/git-clone.txt
</span><span class="token prefix inserted">></span><span class="token line"> @@ -149,6 +149,11 @@ objects from the source repository into a pack in t=
</span></span>he cloned repository.
<span class="token inserted-arrow inserted"><span class="token prefix inserted">></span><span class="token line">  --no-checkout::
</span><span class="token prefix inserted">></span><span class="token line">  	No checkout of HEAD is performed after the clone is complete.
</span><span class="token prefix inserted">></span><span class="token line">
</span><span class="token prefix inserted">></span><span class="token line"> +--[no-]reject-shallow::
</span><span class="token prefix inserted">></span><span class="token line"> +	Fail if the source repository is a shallow repository.
</span><span class="token prefix inserted">></span><span class="token line"> +	The 'clone.rejectShallow' configuration variable can be used to
</span><span class="token prefix inserted">></span><span class="token line"> +	give the default.
</span></span>
使用 `to specify the default` 说起来更顺口一些
I am not a native speaker, either, but I believe that it would "roll off
the tongue" a bit better to say "to specify the default".<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>变量命名问题：</p>
<pre class="line-numbers language-diff" data-language="diff"><code class="language-diff"><span class="token inserted-arrow inserted"><span class="token prefix inserted">></span><span class="token line"> diff --git a/builtin/clone.c b/builtin/clone.c
</span><span class="token prefix inserted">></span><span class="token line"> index 51e844a2de0a..eeddd68a51f4 100644
</span><span class="token prefix inserted">></span><span class="token line"> --- a/builtin/clone.c
</span><span class="token prefix inserted">></span><span class="token line"> +++ b/builtin/clone.c
</span><span class="token prefix inserted">></span><span class="token line"> @@ -50,6 +50,8 @@ static int option_no_checkout, option_bare, option_mir=
</span></span>ror, option_single_branch
<span class="token inserted-arrow inserted"><span class="token prefix inserted">></span><span class="token line">  static int option_local =3D -1, option_no_hardlinks, option_shared;
</span><span class="token prefix inserted">></span><span class="token line">  static int option_no_tags;
</span><span class="token prefix inserted">></span><span class="token line">  static int option_shallow_submodules;
</span><span class="token prefix inserted">></span><span class="token line"> +static int option_shallow = -1;    /* unspecified */
</span><span class="token prefix inserted">></span><span class="token line"> +static int config_shallow = -1;    /* unspecified */
</span></span>
I would much prefer those variable names to include an indicator that this
is about _rejecting_ shallow clones. I.e. `option_reject_shallow`.

Also, I think that we can do with just a single `option_reject_shallow`
(we do not even need that `reject_shallow` variable in `cmd_clone()`):

<span class="token deleted-sign deleted"><span class="token prefix deleted">-</span><span class="token line"> in `git_clone_config()`, only override it if it is still unspecified:
</span></span>
	if (!strcmp(k, "clone.rejectshallow") &amp;&amp; option_reject_shallow &lt; 0)
		option_reject_shallow =3D git_config_bool(k,v);

<span class="token deleted-sign deleted"><span class="token prefix deleted">-</span><span class="token line"> in `cmd_clone()`, test for a _positive_ value:
</span></span>
	if (option_reject_shallow > 0)
		die(_("source repository is shallow, reject to clone."));

<span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line"> and
</span></span>
	if (option_reject_shallow > 0)
<span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">		transport_set_option(transport, TRANS_OPT_REJECT_SHALLOW, "1");
</span></span>
One thing to note (in the commit message, would be my preference) is that
`cmd_clone()` is _particular_ in that it runs `git_config()` _twice_. Once
before the command-line options are parsed, and once after the new Git
repository has been initialized. Note that my suggestion still works with
that: if either the original config, or the new config set
`clone.rejectShallow`, it is picked up correctly, with the latter
overriding the former if both configs want to set it.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>使用 <code>option_reject_shallow</code> 比 <code>config_shallow</code> 更好一些，它能更直接地表明这个选项是要拒绝 <em>shallow clone</em> 的。<s>同时他提醒，在 <code>cmd_clone()</code>函数中 <code>git_config</code> 会被调用两次，使用 <code>option_reject_shallow</code> 能避免在 <code>cmd_clone</code> 中使用 <code>reject_shallow</code></s> 。</p>
<p>P.S. 划线这段话是错误的，见 Johannes 本人回复：<a target="_blank" rel="noopener" href="https://public-inbox.org/git/nycvar.QRO.7.76.6.2104010021510.54@tvgsbejvaqbjf.bet/">Johannes’reply</a>，以及 Junio 的回复：<a target="_blank" rel="noopener" href="https://public-inbox.org/git/xmqqim5754rl.fsf@gitster.g/">Junio’s reply</a>。最后用了两个变量: <code>option_reject_shallow</code>，<code>config_reject_shallow</code>，在 <code>cmd_clone()</code> 中它们共同决定另一个变量：<code>reject_shallow</code>。</p>
<p>后面同样变量命名：</p>
<pre class="line-numbers language-diff" data-language="diff"><code class="language-diff"><span class="token inserted-arrow inserted"><span class="token prefix inserted">></span><span class="token line"> diff --git a/fetch-pack.c b/fetch-pack.c
</span><span class="token prefix inserted">></span><span class="token line"> index fb04a76ca263..34d0c2896e2e 100644
</span><span class="token prefix inserted">></span><span class="token line"> --- a/fetch-pack.c
</span><span class="token prefix inserted">></span><span class="token line"> +++ b/fetch-pack.c
</span><span class="token prefix inserted">></span><span class="token line"> @@ -1129,9 +1129,11 @@ static struct ref *do_fetch_pack(struct fetch_pac=
</span></span>k_args *args,
<span class="token inserted-arrow inserted"><span class="token prefix inserted">></span><span class="token line">  	if (args->deepen)
</span><span class="token prefix inserted">></span><span class="token line">  		setup_alternate_shallow(&amp;shallow_lock, &amp;alternate_shallow_file,
</span><span class="token prefix inserted">></span><span class="token line">  					NULL);
</span><span class="token prefix inserted">></span><span class="token line"> -	else if (si->nr_ours || si->nr_theirs)
</span><span class="token prefix inserted">></span><span class="token line"> +	else if (si->nr_ours || si->nr_theirs) &#123;
</span><span class="token prefix inserted">></span><span class="token line"> +		if (args->remote_shallow)
</span></span>
Even as a non-casual reader, this name `remote_shallow` leads me to assume
incorrect things. This option is not about wanting a remote shallow
repository, it is about rejecting a remote shallow repository.
用 `reject_shallow` 代替 `remote_shllow`
Please name this attribute `reject_shallow` instead of `remote_shallow`.
That will prevent future puzzlement.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>Johannes 还对测试用例提出了一些检视意见，篇幅有限，这里省略。</p>
<p>在最后几个回合，Junio 又给出了很多有意义的检视意见：</p>
<pre class="line-numbers language-diff" data-language="diff"><code class="language-diff"><span class="token inserted-arrow inserted"><span class="token prefix inserted">></span><span class="token line"> In some scenarios, users may want more history than the repository
</span><span class="token prefix inserted">></span><span class="token line"> offered for cloning, which happens to be a shallow repository, can
</span><span class="token prefix inserted">></span><span class="token line"> give them. But because users don't know it is a shallow repository
</span><span class="token prefix inserted">></span><span class="token line"> until they download it to local, users should have the option to
</span></span>
'should' 在这里感觉语气太重了
I find the "should" too strong, but let's keep reading.

<span class="token inserted-arrow inserted"><span class="token prefix inserted">></span><span class="token line"> refuse to clone this kind of repository, and may want to exit the
</span><span class="token prefix inserted">></span><span class="token line"> process immediately without creating any unnecessary files.
</span></span>确认是语气重了。同时存在冗余。
Yes, that is too strong and also redundant.

<span class="token inserted-arrow inserted"><span class="token prefix inserted">></span><span class="token line"> Althought there is an option '--depth=x' for users to decide how
</span><span class="token prefix inserted">></span><span class="token line"> deep history they can fetch, but as the unshallow cloning's depth
</span></span>句子若以 'although' 开头，则后面不应该用 `but`做转折。
"Although"; if you begin with "although", you shouldn't write "but".

<span class="token inserted-arrow inserted"><span class="token prefix inserted">></span><span class="token line"> is INFINITY, we can't know exactly the minimun 'x' value that can
</span><span class="token prefix inserted">></span><span class="token line"> satisfy the minimum integrity,
</span><span class="token prefix inserted">></span><span class="token line"> so we can't pass 'x' value to --depth,
</span><span class="token prefix inserted">></span><span class="token line"> and expect this can obtain a complete history of a repository.
</span></span>
If the argument were "we might start with depth x, and the source
may be deep enough to give us x right now, but we may want to deepen
more than they can offer, and such a user would want to be able to
say 'I want depth=x now, but make sure they are not shallow'", I
would understand it, but I do not see where the "minimum integrity"
comes from---there doesn't appear to be anything related to
integrity here.

<span class="token inserted-arrow inserted"><span class="token prefix inserted">></span><span class="token line"> In other scenarios, if we have an API that allow us to import external
</span></span>
"allows"

<span class="token inserted-arrow inserted"><span class="token prefix inserted">></span><span class="token line"> repository, and then perform various operations on the repo.
</span><span class="token prefix inserted">></span><span class="token line"> But if the imported is a shallow one(which is actually possible), it
</span><span class="token prefix inserted">></span><span class="token line"> will affect the subsequent operations. So we can choose to refuse to
</span><span class="token prefix inserted">></span><span class="token line"> clone, and let's just import a normal repository.
</span></span>建议丢掉这一整段，因为它跟前面讲的场景差不多，并没有提供新信息。
I'd suggest dropping this entire paragraph.  That is not any new
scenario at all.  API or not, you essentially just said "you can do
various things on your clone once you have it, but some things you
may want to do you would want a full history".  That is what you
started the whole discussion above and does not add any new
information.


<span class="token inserted-arrow inserted"><span class="token prefix inserted">></span><span class="token line"> @@ -858,6 +861,9 @@ static int git_clone_config(const char *k, const char *v, void *cb)
</span><span class="token prefix inserted">></span><span class="token line">  		free(remote_name);
</span><span class="token prefix inserted">></span><span class="token line">  		remote_name = xstrdup(v);
</span><span class="token prefix inserted">></span><span class="token line">  	&#125;
</span><span class="token prefix inserted">></span><span class="token line"> +	if (!strcmp(k, "clone.rejectshallow") &amp;&amp; option_reject_shallow &lt; 0)
</span><span class="token prefix inserted">></span><span class="token line"> +		option_reject_shallow = git_config_bool(k, v);
</span></span>
Does this "single variable is enough" really work?

Imagine that the first time around we'd read from $HOME/.gitconfig
that says true (flips the variable from "unspecified").  Further
imagine that we are running "git clone -c config.rejectShallow=no"
to countermand the global config.  We call write_config() to write
the extra configuration value out, and then call git_config() to
read from the repository configuration again.

Because of the value taken from $HOME/.gitconfig, however, the
attempt to override is silently ignored, isn't it?

Other than that, the changes to the code from the previous round
looked sensible.

虽然比上一版的更新好了很多，但Junio并没有放弃任何可能的问题，仍对config配置
和option配置有疑问，他的顾虑是正确的，这为下一版的更新提供了正确的思路。<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这就是我第一次向 Git 社区提交代码的情况：问题多多，反馈多多。各种严谨细致又有启发性的检视意见让我感受到了 Git 社区的技术氛围。这个过程中让我不断思考如何让代码写得更好：更有逻辑，更简洁，更严谨，而不仅仅是实现功能。</p>
<p>这个经验让我想到，在英语中有个两个单词可以很贴切的形容他们对待代码的态度：<code>polish</code>，<code>cooking</code>。<br>
<code>polish</code> 动词意为润色，修改，抛光，打磨。用在代码上， commit 信息上，甚至写文档上，意味着这些过程是不断改进，不断变得更好。<br>
<code>cooking</code> 意为烹饪，比喻写代码就像烹饪，所谓心急吃不了热豆腐，即使做简单的菜都需要耐心，细心。</p>
<p>回到主题，前面的每次修改，直接强推到原来的PR中即可， <a target="_blank" rel="noopener" href="https://gitgitgadget.github.io/">GitGitGadget</a> 会自动将每次的更新转换为不同的版本再提交到上游社区。那如何确定提交的版本是最终版本呢？前面提到过 Git 的几个主要分支，当我提交到第十版后，很快就被合入到 <code>seen</code>分支，意味着被初步接受，然后又马上进入 <code>next</code> 分支，意味着各项测试也没问题，然后又马上进入 <code>master</code> 分支。特别地，这个过程会有 <strong>状态更新</strong> 提醒， Git 社区有个 <a target="_blank" rel="noopener" href="https://lore.kernel.org/git/xmqqy2dw2pai.fsf@gitster.g/#r">What’s cooking in git.git</a> 栏目，是维护者 Junio 用来管理各种提交的状态更新的，它会表明目前社区正在 cooking 哪些人的哪些代码(patch)，以及各个代码的目前状态。当你的代码在 <strong>What’s cooking in git.git</strong>  中进入 <code>Graduated to 'master'</code> 或者 <code>Will merge to 'master'</code>，那就表明马上会合入主线啦。</p>

<div class="article-footer fs14">
    <section id="license">
      <div class="header"><span>许可协议</span></div>
      <div class="body"><p>本文采用 <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">署名-非商业性使用-相同方式共享 4.0 国际</a> 许可协议，转载请注明出处。</p>
</div>
    </section>
    </div>
</article>
<div class="related-wrap" id="read-next"><section class="body"><div class="item" id="prev"><div class="note">较新文章</div><a href="4da024a6.html">docker 的使用笔记</a></div><div class="item" id="next"><div class="note">较早文章</div><a href="d699447b.html">如何向 Git 社区提交代码</a></div></section></div>




  <div class="related-wrap md-text" id="comments">
    <section class='header cmt-title cap theme'>
      <p>快来参与讨论吧~</p>

    </section>
    <section class='body cmt-body utterances'>
      

<svg class="loading" style="vertical-align:middle;fill:currentColor;overflow:hidden;" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="2709"><path d="M832 512c0-176-144-320-320-320V128c211.2 0 384 172.8 384 384h-64zM192 512c0 176 144 320 320 320v64C300.8 896 128 723.2 128 512h64z" p-id="2710"></path></svg>

<div id="utterances" repo="Cactusinhand/blog-comments" issue-term="pathname" theme="preferred-color-scheme"></div>

    </section>
  </div>



<footer class="page-footer footnote"><hr><div class="text"><p>本站由 <a href="/">Cactusinhand</a> 使用 <a target="_blank" rel="noopener" href="https://github.com/xaoxuu/hexo-theme-stellar/tree/1.28.1">Stellar 1.28.1</a> 主题创建。本博客所有文章除特别声明外，均采用 <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> 许可协议，转载请注明出处。</p>
</div></footer>
<div class="main-mask" onclick="sidebar.dismiss()"></div></div><aside class="l_right">
<div class="widgets">



<widget class="widget-wrapper toc" id="data-toc" collapse="false"><div class="widget-header dis-select"><span class="name">本文目录</span><a class="cap-action" onclick="sidebar.toggleTOC()" ><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6h11m-11 6h11m-11 6h11M4 6h1v4m-1 0h2m0 8H4c0-1 2-2 2-3s-1-1.5-2-1"/></svg></a></div><div class="widget-body"><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%83%8C%E6%99%AF"><span class="toc-text">背景</span></a></li></ol></div><div class="widget-footer">

<a class="top" onclick="util.scrollTop()"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><g fill="none" stroke="currentColor" stroke-width="1.5"><path d="M2 12c0-4.714 0-7.071 1.464-8.536C4.93 2 7.286 2 12 2c4.714 0 7.071 0 8.535 1.464C22 4.93 22 7.286 22 12c0 4.714 0 7.071-1.465 8.535C19.072 22 16.714 22 12 22s-7.071 0-8.536-1.465C2 19.072 2 16.714 2 12Z"/><path stroke-linecap="round" stroke-linejoin="round" d="m9 15.5l3-3l3 3m-6-4l3-3l3 3"/></g></svg><span>回到顶部</span></a><a class="buttom" onclick="util.scrollComment()"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M10.46 1.25h3.08c1.603 0 2.86 0 3.864.095c1.023.098 1.861.3 2.6.752a5.75 5.75 0 0 1 1.899 1.899c.452.738.654 1.577.752 2.6c.095 1.004.095 2.261.095 3.865v1.067c0 1.141 0 2.036-.05 2.759c-.05.735-.153 1.347-.388 1.913a5.75 5.75 0 0 1-3.112 3.112c-.805.334-1.721.408-2.977.43a10.81 10.81 0 0 0-.929.036c-.198.022-.275.054-.32.08c-.047.028-.112.078-.224.232c-.121.166-.258.396-.476.764l-.542.916c-.773 1.307-2.69 1.307-3.464 0l-.542-.916a10.605 10.605 0 0 0-.476-.764c-.112-.154-.177-.204-.224-.232c-.045-.026-.122-.058-.32-.08c-.212-.023-.49-.03-.93-.037c-1.255-.021-2.171-.095-2.976-.429A5.75 5.75 0 0 1 1.688 16.2c-.235-.566-.338-1.178-.389-1.913c-.049-.723-.049-1.618-.049-2.76v-1.066c0-1.604 0-2.86.095-3.865c.098-1.023.3-1.862.752-2.6a5.75 5.75 0 0 1 1.899-1.899c.738-.452 1.577-.654 2.6-.752C7.6 1.25 8.857 1.25 10.461 1.25M6.739 2.839c-.914.087-1.495.253-1.959.537A4.25 4.25 0 0 0 3.376 4.78c-.284.464-.45 1.045-.537 1.96c-.088.924-.089 2.11-.089 3.761v1c0 1.175 0 2.019.046 2.685c.045.659.131 1.089.278 1.441a4.25 4.25 0 0 0 2.3 2.3c.515.214 1.173.294 2.429.316h.031c.398.007.747.013 1.037.045c.311.035.616.104.909.274c.29.17.5.395.682.645c.169.232.342.525.538.856l.559.944a.52.52 0 0 0 .882 0l.559-.944c.196-.331.37-.624.538-.856c.182-.25.392-.476.682-.645c.293-.17.598-.24.909-.274c.29-.032.639-.038 1.037-.045h.032c1.255-.022 1.913-.102 2.428-.316a4.25 4.25 0 0 0 2.3-2.3c.147-.352.233-.782.278-1.441c.046-.666.046-1.51.046-2.685v-1c0-1.651 0-2.837-.089-3.762c-.087-.914-.253-1.495-.537-1.959a4.25 4.25 0 0 0-1.403-1.403c-.464-.284-1.045-.45-1.96-.537c-.924-.088-2.11-.089-3.761-.089h-3c-1.651 0-2.837 0-3.762.089" clip-rule="evenodd"/><path fill="currentColor" d="M9 11a1 1 0 1 1-2 0a1 1 0 0 1 2 0m4 0a1 1 0 1 1-2 0a1 1 0 0 1 2 0m4 0a1 1 0 1 1-2 0a1 1 0 0 1 2 0"/></svg><span>参与讨论</span></a></div></widget>
</div></aside><div class='float-panel blur'>
  <button type='button' style='display:none' class='laptop-only rightbar-toggle mobile' onclick='sidebar.rightbar()'>
    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6h11m-11 6h11m-11 6h11M4 6h1v4m-1 0h2m0 8H4c0-1 2-2 2-3s-1-1.5-2-1"/></svg>
  </button>
  <button type='button' style='display:none' class='mobile-only leftbar-toggle mobile' onclick='sidebar.leftbar()'>
    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><g fill="none" stroke="currentColor" stroke-width="1.5"><path d="M2 11c0-3.771 0-5.657 1.172-6.828C4.343 3 6.229 3 10 3h4c3.771 0 5.657 0 6.828 1.172C22 5.343 22 7.229 22 11v2c0 3.771 0 5.657-1.172 6.828C19.657 21 17.771 21 14 21h-4c-3.771 0-5.657 0-6.828-1.172C2 18.657 2 16.771 2 13z"/><path id="sep" stroke-linecap="round" d="M5.5 10h6m-5 4h4m4.5 7V3"/></g></svg>
  </button>
</div>
</div><div class="scripts">
<script type="text/javascript">
  const ctx = {
    date_suffix: {
      just: `刚刚`,
      min: `分钟前`,
      hour: `小时前`,
      day: `天前`,
    },
    root : `/`,
  };

  // required plugins (only load if needs)
  if (`local_search`) {
    ctx.search = {};
    ctx.search.service = `local_search`;
    if (ctx.search.service == 'local_search') {
      let service_obj = Object.assign({}, `{"field":"all","path":"/search.json","content":true,"sort":"-date"}`);
      ctx.search[ctx.search.service] = service_obj;
    }
  }
  const def = {
    avatar: `https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.12/avatar/round/3442075.svg`,
    cover: `https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.12/cover/76b86c0226ffd.svg`,
  };
  const deps = {
    jquery: `https://cdn.bootcdn.net/ajax/libs/jquery/3.7.1/jquery.min.js`,
    marked: `https://cdn.bootcdn.net/ajax/libs/marked/4.0.18/marked.min.js`
  }
  

</script>

<script type="text/javascript">
  const utils = {
    // 懒加载 css https://github.com/filamentgroup/loadCSS
    css: (href, before, media, attributes) => {
      var doc = window.document;
      var ss = doc.createElement("link");
      var ref;
      if (before) {
        ref = before;
      } else {
        var refs = (doc.body || doc.getElementsByTagName("head")[0]).childNodes;
        ref = refs[refs.length - 1];
      }
      var sheets = doc.styleSheets;
      if (attributes) {
        for (var attributeName in attributes) {
          if (attributes.hasOwnProperty(attributeName)) {
            ss.setAttribute(attributeName, attributes[attributeName]);
          }
        }
      }
      ss.rel = "stylesheet";
      ss.href = href;
      ss.media = "only x";
      function ready(cb) {
        if (doc.body) {
          return cb();
        }
        setTimeout(function () {
          ready(cb);
        });
      }
      ready(function () {
        ref.parentNode.insertBefore(ss, before ? ref : ref.nextSibling);
      });
      var onloadcssdefined = function (cb) {
        var resolvedHref = ss.href;
        var i = sheets.length;
        while (i--) {
          if (sheets[i].href === resolvedHref) {
            return cb();
          }
        }
        setTimeout(function () {
          onloadcssdefined(cb);
        });
      };
      function loadCB() {
        if (ss.addEventListener) {
          ss.removeEventListener("load", loadCB);
        }
        ss.media = media || "all";
      }
      if (ss.addEventListener) {
        ss.addEventListener("load", loadCB);
      }
      ss.onloadcssdefined = onloadcssdefined;
      onloadcssdefined(loadCB);
      return ss;
    },

    js: (src, opt) => new Promise((resolve, reject) => {
      var script = document.createElement('script');
      if (src.startsWith('/')){
        src = ctx.root + src.substring(1);
      }
      script.src = src;
      if (opt) {
        for (let key of Object.keys(opt)) {
          script[key] = opt[key]
        }
      } else {
        // 默认异步，如果需要同步，第二个参数传入 {} 即可
        script.async = true
      }
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    }),

    jq: (fn) => {
      if (typeof jQuery === 'undefined') {
        utils.js(deps.jquery).then(fn)
      } else {
        fn()
      }
    },
    
    onLoading: (el) => {
      if (el) {
        $(el).append('<div class="loading-wrap"><svg xmlns="http://www.w3.org/2000/svg" width="2em" height="2em" preserveAspectRatio="xMidYMid meet" viewBox="0 0 24 24"><g fill="none" stroke="currentColor" stroke-linecap="round" stroke-width="2"><path stroke-dasharray="60" stroke-dashoffset="60" stroke-opacity=".3" d="M12 3C16.9706 3 21 7.02944 21 12C21 16.9706 16.9706 21 12 21C7.02944 21 3 16.9706 3 12C3 7.02944 7.02944 3 12 3Z"><animate fill="freeze" attributeName="stroke-dashoffset" dur="1.3s" values="60;0"/></path><path stroke-dasharray="15" stroke-dashoffset="15" d="M12 3C16.9706 3 21 7.02944 21 12"><animate fill="freeze" attributeName="stroke-dashoffset" dur="0.3s" values="15;0"/><animateTransform attributeName="transform" dur="1.5s" repeatCount="indefinite" type="rotate" values="0 12 12;360 12 12"/></path></g></svg></div>');
      }
    },
    onLoadSuccess: (el) => {
      if (el) {
        $(el).find('.loading-wrap').remove();
      }
    },
    onLoadFailure: (el) => {
      if (el) {
        $(el).find('.loading-wrap svg').remove();
        $(el).find('.loading-wrap').append('<svg xmlns="http://www.w3.org/2000/svg" width="2em" height="2em" preserveAspectRatio="xMidYMid meet" viewBox="0 0 24 24"><g fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"><path stroke-dasharray="60" stroke-dashoffset="60" d="M12 3L21 20H3L12 3Z"><animate fill="freeze" attributeName="stroke-dashoffset" dur="0.5s" values="60;0"/></path><path stroke-dasharray="6" stroke-dashoffset="6" d="M12 10V14"><animate fill="freeze" attributeName="stroke-dashoffset" begin="0.6s" dur="0.2s" values="6;0"/></path></g><circle cx="12" cy="17" r="1" fill="currentColor" fill-opacity="0"><animate fill="freeze" attributeName="fill-opacity" begin="0.8s" dur="0.4s" values="0;1"/></circle></svg>');
        $(el).find('.loading-wrap').addClass('error');
      }
    },
    request: (el, url, callback, onFailure) => {
      let retryTimes = 3;
      utils.onLoading(el);
      function req() {
        return new Promise((resolve, reject) => {
          let status = 0; // 0 等待 1 完成 2 超时
          let timer = setTimeout(() => {
            if (status === 0) {
              status = 2;
              timer = null;
              reject('请求超时');
              if (retryTimes == 0) {
                onFailure();
              }
            }
          }, 5000);
          fetch(url).then(function(response) {
            if (status !== 2) {
              clearTimeout(timer);
              resolve(response);
              timer = null;
              status = 1;
            }
            if (response.ok) {
              return response.json();
            }
            throw new Error('Network response was not ok.');
          }).then(function(data) {
            retryTimes = 0;
            utils.onLoadSuccess(el);
            callback(data);
          }).catch(function(error) {
            if (retryTimes > 0) {
              retryTimes -= 1;
              setTimeout(() => {
                req();
              }, 5000);
            } else {
              utils.onLoadFailure(el);
              onFailure();
            }
          });
        });
      }
      req();
    },
  };
</script>

<script>
  const sidebar = {
    leftbar: () => {
      if (l_body) {
        l_body.toggleAttribute('leftbar');
        l_body.removeAttribute('rightbar');
      }
    },
    rightbar: () => {
      if (l_body) {
        l_body.toggleAttribute('rightbar');
        l_body.removeAttribute('leftbar');
      }
    },
    dismiss: () => {
      if (l_body) {
        l_body.removeAttribute('leftbar');
        l_body.removeAttribute('rightbar');
      }
    },
    toggleTOC: () => {
      document.querySelector('#data-toc').classList.toggle('collapse');
    }
  }
</script>

<!-- required -->
<script src="/js/main.js?v=1.28.1" async></script>

<script type="text/javascript">
  const applyTheme = (theme) => {
    if (theme === 'auto') {
      document.documentElement.removeAttribute('data-theme')
    } else {
      document.documentElement.setAttribute('data-theme', theme)
    }

    applyThemeToGiscus(theme)
  }

  const applyThemeToGiscus = (theme) => {
    theme = theme === 'auto' ? 'preferred_color_scheme' : theme

    const cmt = document.getElementById('giscus')
    if (cmt) {
      // This works before giscus load.
      cmt.setAttribute('data-theme', theme)
    }

    const iframe = document.querySelector('#comments > section.giscus > iframe')
    if (iframe) {
      // This works after giscus loaded.
      const src = iframe.src
      const newSrc = src.replace(/theme=[\w]+/, `theme=${theme}`)
      iframe.src = newSrc
    }
  }

  const switchTheme = () => {
    // light -> dark -> auto -> light -> ...
    const currentTheme = document.documentElement.getAttribute('data-theme')
    let newTheme;
    switch (currentTheme) {
      case 'light':
        newTheme = 'dark'
        break
      case 'dark':
        newTheme = 'auto'
        break
      default:
        newTheme = 'light'
    }
    applyTheme(newTheme)
    window.localStorage.setItem('Stellar.theme', newTheme)

    const messages = {
      light: `切换到浅色模式`,
      dark: `切换到深色模式`,
      auto: `切换到跟随系统配色`,
    }
    hud?.toast?.(messages[newTheme])
  }

  (() => {
    // Apply user's preferred theme, if any.
    const theme = window.localStorage.getItem('Stellar.theme')
    if (theme !== null) {
      applyTheme(theme)
    }
  })()
</script>


<!-- optional -->

  <script>
  function loadUtterances() {
    const els = document.querySelectorAll("#comments #utterances");
    if (els.length === 0) return;
    els.forEach((el, i) => {
      try {
        el.innerHTML = '';
      } catch (error) {
        console.error(error);
      }
      var script = document.createElement('script');
      script.src = 'https://utteranc.es/client.js';
      script.async = true;
      for (let key of Object.keys(el.attributes)) {
        let attr = el.attributes[key];
        if (['class', 'id'].includes(attr.name) === false) {
          script.setAttribute(attr.name, attr.value);
        }
      }
      el.appendChild(script);
    });
  }
  window.addEventListener('DOMContentLoaded', (event) => {
      loadUtterances();
  });
</script>




<script defer>
  window.addEventListener('DOMContentLoaded', (event) => {
    ctx.services = Object.assign({}, JSON.parse(`{"mdrender":{"js":"/js/services/mdrender.js"},"siteinfo":{"js":"/js/services/siteinfo.js","api":null},"ghinfo":{"js":"/js/services/ghinfo.js"},"sites":{"js":"/js/services/sites.js"},"friends":{"js":"/js/services/friends.js"},"timeline":{"js":"/js/services/timeline.js"},"fcircle":{"js":"/js/services/fcircle.js"},"weibo":{"js":"/js/services/weibo.js"},"memos":{"js":"/js/services/memos.js"}}`));
    for (let id of Object.keys(ctx.services)) {
      const js = ctx.services[id].js;
      if (id == 'siteinfo') {
        ctx.cardlinks = document.querySelectorAll('a.link-card[cardlink]');
        if (ctx.cardlinks?.length > 0) {
          utils.js(js, { defer: true }).then(function () {
            setCardLink(ctx.cardlinks);
          });
        }
      } else {
        const els = document.getElementsByClassName(`ds-${id}`);
        if (els?.length > 0) {
          utils.jq(() => {
            if (id == 'timeline' || 'memos' || 'marked') {
              utils.js(deps.marked).then(function () {
                utils.js(js, { defer: true });
              });
            } else {
              utils.js(js, { defer: true });
            }
          });
        }
      }
    }
  });
</script>

<script>
  window.addEventListener('DOMContentLoaded', (event) => {
    ctx.search = {
      path: `/search.json`,
    }
    utils.js('/js/search/local-search.js', { defer: true });
  });
</script><script>
  window.FPConfig = {
    delay: 0,
    ignoreKeywords: [],
    maxRPS: 5,
    hoverDelay: 25
  };
</script>
<script defer src="https://cdn.bootcdn.net/ajax/libs/flying-pages/2.1.2/flying-pages.min.js"></script><script defer src="https://cdn.bootcdn.net/ajax/libs/vanilla-lazyload/17.8.4/lazyload.min.js"></script>
<script>
  // https://www.npmjs.com/package/vanilla-lazyload
  // Set the options globally
  // to make LazyLoad self-initialize
  window.lazyLoadOptions = {
    elements_selector: ".lazy",
  };
  // Listen to the initialization event
  // and get the instance of LazyLoad
  window.addEventListener(
    "LazyLoad::Initialized",
    function (event) {
      window.lazyLoadInstance = event.detail.instance;
    },
    false
  );
  document.addEventListener('DOMContentLoaded', function () {
    window.lazyLoadInstance?.update();
  });
</script><script>
  ctx.fancybox = {
    selector: `.timenode p>img`,
    css: `https://cdn.bootcdn.net/ajax/libs/fancyapps-ui/5.0.22/fancybox/fancybox.min.css`,
    js: `https://cdn.bootcdn.net/ajax/libs/fancyapps-ui/5.0.22/fancybox/fancybox.umd.min.js`
  };
  var selector = '[data-fancybox]:not(.error)';
  if (ctx.fancybox.selector) {
    selector += `, ${ctx.fancybox.selector}`
  }
  var needFancybox = document.querySelectorAll(selector).length !== 0;
  if (!needFancybox) {
    const els = document.getElementsByClassName('ds-memos');
    if (els != undefined && els.length > 0) {
      needFancybox = true;
    }
  }
  if (needFancybox) {
    utils.css(ctx.fancybox.css);
    utils.js(ctx.fancybox.js, { defer: true }).then(function () {
      Fancybox.bind(selector, {
        hideScrollbar: false,
        Thumbs: {
          autoStart: false,
        },
        caption: (fancybox, slide) => {
          return slide.triggerEl.alt || slide.triggerEl.dataset.caption || null
        }
      });
    })
  }
</script>
<script>
  window.addEventListener('DOMContentLoaded', (event) => {
    const swiper_api = document.getElementById('swiper-api');
    if (swiper_api != undefined) {
      utils.css(`https://unpkg.com/swiper@10.3.1/swiper-bundle.min.css`);
      utils.js(`https://unpkg.com/swiper@10.3.1/swiper-bundle.min.js`, { defer: true }).then(function () {
        const effect = swiper_api.getAttribute('effect') || '';
        var swiper = new Swiper('.swiper#swiper-api', {
          slidesPerView: 'auto',
          spaceBetween: 8,
          centeredSlides: true,
          effect: effect,
          rewind: true,
          pagination: {
            el: '.swiper-pagination',
            clickable: true,
          },
          navigation: {
            nextEl: '.swiper-button-next',
            prevEl: '.swiper-button-prev',
          },
        });
      })
    }
  });
</script>
<script>
  document.addEventListener('DOMContentLoaded', function () {
    window.codeElements = document.querySelectorAll('.code');
    if (window.codeElements.length > 0) {
      ctx.copycode = {
        default_text: `Copy`,
        success_text: `Copied`,
        toast: `复制成功`,
      };
      utils.js('/js/plugins/copycode.js');
    }
  });
</script>


<!-- inject -->

</div></body></html>
